{
  "openapi": "3.0.0",
  "info": {
    "title": "Get Revenue Concentration",
    "version": "1.0.0",
    "description": "Retrieve customer dependency risk metrics showing revenue concentration from top customers and HHI (Herfindahl-Hirschman Index) for a specified period."
  },
  "servers": [
    {
      "url": "https://oppspot-one.vercel.app/api",
      "description": "Production"
    },
    {
      "url": "http://localhost:3000/api",
      "description": "Development"
    }
  ],
  "paths": {
    "/companies/{companyId}/financials/concentration": {
      "get": {
        "summary": "Get revenue concentration analysis",
        "description": "Retrieve customer dependency metrics showing what percentage of revenue comes from top 1, 3, 5, and 10 customers, plus concentration index (HHI) and risk flags.",
        "operationId": "getRevenueConcentration",
        "tags": ["Financial Analytics"],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "companyId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "UUID of company to retrieve data for",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          {
            "name": "period_date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Period to analyze (last day of month). Defaults to most recent snapshot.",
            "example": "2024-12-31"
          }
        ],
        "responses": {
          "200": {
            "description": "Revenue concentration retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/RevenueConcentration"
                    }
                  }
                },
                "examples": {
                  "low_concentration": {
                    "summary": "Healthy diversification (no risk)",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "period_date": "2024-12-31",
                        "currency": "USD",
                        "total_mrr": 100000.0,
                        "top_1_customer_mrr": 8000.0,
                        "top_1_customer_pct": 8.0,
                        "top_3_customers_pct": 20.0,
                        "top_5_customers_pct": 30.0,
                        "top_10_customers_pct": 50.0,
                        "concentration_index": 850.0,
                        "concentration_level": "low",
                        "risk_flag": false,
                        "top_customers": [
                          {
                            "customer_id": "c1",
                            "customer_name": "Acme Corp",
                            "mrr": 8000.0,
                            "pct_of_total": 8.0,
                            "rank": 1
                          },
                          {
                            "customer_id": "c2",
                            "customer_name": "TechCo",
                            "mrr": 7000.0,
                            "pct_of_total": 7.0,
                            "rank": 2
                          },
                          {
                            "customer_id": "c3",
                            "customer_name": "StartupX",
                            "mrr": 5000.0,
                            "pct_of_total": 5.0,
                            "rank": 3
                          }
                        ],
                        "calculated_at": "2024-10-30T20:00:00Z"
                      }
                    }
                  },
                  "high_concentration_risk": {
                    "summary": "High customer dependency (risk flagged)",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "period_date": "2024-12-31",
                        "currency": "USD",
                        "total_mrr": 50000.0,
                        "top_1_customer_mrr": 18000.0,
                        "top_1_customer_pct": 36.0,
                        "top_3_customers_pct": 70.0,
                        "top_5_customers_pct": 85.0,
                        "top_10_customers_pct": 95.0,
                        "concentration_index": 2850.0,
                        "concentration_level": "high",
                        "risk_flag": true,
                        "top_customers": [
                          {
                            "customer_id": "c1",
                            "customer_name": "MegaCorp",
                            "mrr": 18000.0,
                            "pct_of_total": 36.0,
                            "rank": 1
                          },
                          {
                            "customer_id": "c2",
                            "customer_name": "BigCustomer Inc",
                            "mrr": 10000.0,
                            "pct_of_total": 20.0,
                            "rank": 2
                          },
                          {
                            "customer_id": "c3",
                            "customer_name": "LargeCo",
                            "mrr": 7000.0,
                            "pct_of_total": 14.0,
                            "rank": 3
                          }
                        ],
                        "calculated_at": "2024-10-30T20:00:00Z"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid parameters",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Company not found or no data for period",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "examples": {
                  "no_data": {
                    "summary": "No concentration data for period",
                    "value": {
                      "error": {
                        "code": "NOT_FOUND",
                        "message": "No revenue concentration data for period 2024-12-31"
                      }
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "RevenueConcentration": {
        "type": "object",
        "required": [
          "company_id",
          "period_date",
          "currency",
          "total_mrr",
          "top_1_customer_mrr",
          "top_1_customer_pct",
          "top_3_customers_pct",
          "top_5_customers_pct",
          "top_10_customers_pct",
          "concentration_index",
          "concentration_level",
          "risk_flag",
          "calculated_at"
        ],
        "properties": {
          "company_id": {
            "type": "string",
            "format": "uuid"
          },
          "period_date": {
            "type": "string",
            "format": "date",
            "description": "Last day of analysis month"
          },
          "currency": {
            "type": "string",
            "description": "ISO 4217 currency code"
          },
          "total_mrr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Total MRR for period"
          },
          "top_1_customer_mrr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "MRR from largest customer"
          },
          "top_1_customer_pct": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "description": "% of revenue from top customer"
          },
          "top_3_customers_pct": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "description": "% of revenue from top 3 customers"
          },
          "top_5_customers_pct": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "description": "% of revenue from top 5 customers"
          },
          "top_10_customers_pct": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "description": "% of revenue from top 10 customers"
          },
          "concentration_index": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 10000,
            "description": "Herfindahl-Hirschman Index (HHI)"
          },
          "concentration_level": {
            "type": "string",
            "enum": ["low", "moderate", "high"],
            "description": "Concentration level: low (<1500 HHI), moderate (1500-2500), high (>2500)"
          },
          "risk_flag": {
            "type": "boolean",
            "description": "True if top customer >25% of revenue (FR-016 threshold)"
          },
          "top_customers": {
            "type": "array",
            "description": "Details of top 10 customers by revenue (optional, for drill-down)",
            "items": {
              "$ref": "#/components/schemas/TopCustomer"
            }
          },
          "calculated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "TopCustomer": {
        "type": "object",
        "required": ["customer_id", "customer_name", "mrr", "pct_of_total", "rank"],
        "properties": {
          "customer_id": {
            "type": "string",
            "format": "uuid"
          },
          "customer_name": {
            "type": "string"
          },
          "mrr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0
          },
          "pct_of_total": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "description": "Percentage of total revenue"
          },
          "rank": {
            "type": "integer",
            "minimum": 1,
            "maximum": 10,
            "description": "Revenue rank (1 = largest)"
          }
        }
      },
      "Error": {
        "type": "object",
        "required": ["error"],
        "properties": {
          "error": {
            "type": "object",
            "required": ["code", "message"],
            "properties": {
              "code": {
                "type": "string"
              },
              "message": {
                "type": "string"
              },
              "details": {
                "type": "object"
              }
            }
          }
        }
      }
    }
  }
}
