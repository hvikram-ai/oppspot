{
  "openapi": "3.0.0",
  "info": {
    "title": "Get AR/AP Aging Analysis",
    "version": "1.0.0",
    "description": "Retrieve accounts receivable and accounts payable aging analysis showing outstanding amounts by age buckets (0-30, 31-60, 61-90, 90+ days) plus DSO and DPO metrics."
  },
  "servers": [
    {
      "url": "https://oppspot-one.vercel.app/api",
      "description": "Production"
    },
    {
      "url": "http://localhost:3000/api",
      "description": "Development"
    }
  ],
  "paths": {
    "/companies/{companyId}/financials/ar-ap-aging": {
      "get": {
        "summary": "Get AR/AP aging analysis",
        "description": "Retrieve aging buckets for outstanding receivables and payables showing collection/payment efficiency trends. Includes Days Sales Outstanding (DSO) and Days Payables Outstanding (DPO) calculations.",
        "operationId": "getArApAging",
        "tags": ["Financial Analytics"],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "companyId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "UUID of company to retrieve data for",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          {
            "name": "snapshot_date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Date to analyze aging (defaults to most recent snapshot)",
            "example": "2024-12-31"
          }
        ],
        "responses": {
          "200": {
            "description": "AR/AP aging retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "$ref": "#/components/schemas/ArApAging"
                    }
                  }
                },
                "examples": {
                  "healthy_collection": {
                    "summary": "Healthy AR aging (most current)",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "snapshot_date": "2024-12-31",
                        "currency": "USD",
                        "accounts_receivable": {
                          "ar_0_30_days": 80000.0,
                          "ar_31_60_days": 15000.0,
                          "ar_61_90_days": 3000.0,
                          "ar_90_plus_days": 2000.0,
                          "total_ar": 100000.0,
                          "dso": 32.5
                        },
                        "accounts_payable": {
                          "ap_0_30_days": 25000.0,
                          "ap_31_60_days": 5000.0,
                          "ap_61_90_days": 0.0,
                          "ap_90_plus_days": 0.0,
                          "total_ap": 30000.0,
                          "dpo": 28.0
                        },
                        "anomalies_detected": [],
                        "calculated_at": "2024-10-30T20:00:00Z"
                      }
                    }
                  },
                  "collection_issues": {
                    "summary": "AR aging with collection problems",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "snapshot_date": "2024-12-31",
                        "currency": "USD",
                        "accounts_receivable": {
                          "ar_0_30_days": 50000.0,
                          "ar_31_60_days": 30000.0,
                          "ar_61_90_days": 15000.0,
                          "ar_90_plus_days": 25000.0,
                          "total_ar": 120000.0,
                          "dso": 58.0
                        },
                        "accounts_payable": null,
                        "anomalies_detected": [
                          {
                            "type": "ar_aging_spike",
                            "severity": "high",
                            "description": "90+ day receivables increased 80% from previous month (was $13,889)",
                            "current_value": 25000.0,
                            "previous_value": 13889.0
                          }
                        ],
                        "calculated_at": "2024-10-30T20:00:00Z"
                      }
                    }
                  },
                  "no_ap_data": {
                    "summary": "AR only (no payables uploaded)",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "snapshot_date": "2024-12-31",
                        "currency": "USD",
                        "accounts_receivable": {
                          "ar_0_30_days": 90000.0,
                          "ar_31_60_days": 8000.0,
                          "ar_61_90_days": 1500.0,
                          "ar_90_plus_days": 500.0,
                          "total_ar": 100000.0,
                          "dso": 30.0
                        },
                        "accounts_payable": null,
                        "anomalies_detected": [],
                        "calculated_at": "2024-10-30T20:00:00Z"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid parameters",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Company not found or no data for snapshot date",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "ArApAging": {
        "type": "object",
        "required": [
          "company_id",
          "snapshot_date",
          "currency",
          "accounts_receivable",
          "calculated_at"
        ],
        "properties": {
          "company_id": {
            "type": "string",
            "format": "uuid"
          },
          "snapshot_date": {
            "type": "string",
            "format": "date",
            "description": "Date of aging snapshot"
          },
          "currency": {
            "type": "string",
            "description": "ISO 4217 currency code"
          },
          "accounts_receivable": {
            "$ref": "#/components/schemas/AccountsReceivable"
          },
          "accounts_payable": {
            "allOf": [
              {
                "$ref": "#/components/schemas/AccountsPayable"
              }
            ],
            "nullable": true,
            "description": "Null if no payable data uploaded"
          },
          "anomalies_detected": {
            "type": "array",
            "description": "Detected aging anomalies (e.g., 90+ day spike)",
            "items": {
              "$ref": "#/components/schemas/AgingAnomaly"
            }
          },
          "calculated_at": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "AccountsReceivable": {
        "type": "object",
        "required": [
          "ar_0_30_days",
          "ar_31_60_days",
          "ar_61_90_days",
          "ar_90_plus_days",
          "total_ar",
          "dso"
        ],
        "properties": {
          "ar_0_30_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 0-30 days"
          },
          "ar_31_60_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 31-60 days"
          },
          "ar_61_90_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 61-90 days"
          },
          "ar_90_plus_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 90+ days"
          },
          "total_ar": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Total accounts receivable"
          },
          "dso": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Days Sales Outstanding"
          }
        }
      },
      "AccountsPayable": {
        "type": "object",
        "required": [
          "ap_0_30_days",
          "ap_31_60_days",
          "ap_61_90_days",
          "ap_90_plus_days",
          "total_ap",
          "dpo"
        ],
        "properties": {
          "ap_0_30_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 0-30 days"
          },
          "ap_31_60_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 31-60 days"
          },
          "ap_61_90_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 61-90 days"
          },
          "ap_90_plus_days": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Outstanding 90+ days"
          },
          "total_ap": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Total accounts payable"
          },
          "dpo": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Days Payables Outstanding"
          }
        }
      },
      "AgingAnomaly": {
        "type": "object",
        "required": ["type", "severity", "description", "current_value"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["ar_aging_spike"],
            "description": "Anomaly type"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high"]
          },
          "description": {
            "type": "string",
            "description": "Human-readable anomaly explanation"
          },
          "current_value": {
            "type": "number",
            "format": "decimal"
          },
          "previous_value": {
            "type": "number",
            "format": "decimal",
            "description": "Previous period value for comparison"
          }
        }
      },
      "Error": {
        "type": "object",
        "required": ["error"],
        "properties": {
          "error": {
            "type": "object",
            "required": ["code", "message"],
            "properties": {
              "code": {
                "type": "string"
              },
              "message": {
                "type": "string"
              },
              "details": {
                "type": "object"
              }
            }
          }
        }
      }
    }
  }
}
