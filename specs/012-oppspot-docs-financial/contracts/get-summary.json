{
  "openapi": "3.0.0",
  "info": {
    "title": "Get Financial Summary",
    "version": "1.0.0",
    "description": "Retrieve financial KPI summary for a company over a specified time period. Returns precomputed snapshots with metrics like ARR, MRR, NRR, GRR, CAC, LTV, and gross margin."
  },
  "servers": [
    {
      "url": "https://oppspot-one.vercel.app/api",
      "description": "Production"
    },
    {
      "url": "http://localhost:3000/api",
      "description": "Development"
    }
  ],
  "paths": {
    "/companies/{companyId}/financials/summary": {
      "get": {
        "summary": "Get financial KPI summary",
        "description": "Retrieve precomputed financial metrics for specified time period. Supports filtering by date range and time window (monthly/quarterly).",
        "operationId": "getFinancialSummary",
        "tags": ["Financial Analytics"],
        "security": [
          {
            "bearerAuth": []
          }
        ],
        "parameters": [
          {
            "name": "companyId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "description": "UUID of company to retrieve data for",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          {
            "name": "start_date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "Start date (inclusive). Defaults to 12 months ago.",
            "example": "2023-01-01"
          },
          {
            "name": "end_date",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "format": "date"
            },
            "description": "End date (inclusive). Defaults to current month.",
            "example": "2024-12-31"
          },
          {
            "name": "window",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["monthly", "quarterly"],
              "default": "monthly"
            },
            "description": "Time window for aggregation",
            "example": "monthly"
          }
        ],
        "responses": {
          "200": {
            "description": "Financial summary retrieved successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "required": ["success", "data"],
                  "properties": {
                    "success": {
                      "type": "boolean",
                      "example": true
                    },
                    "data": {
                      "type": "object",
                      "required": ["company_id", "currency", "period", "snapshots", "metadata"],
                      "properties": {
                        "company_id": {
                          "type": "string",
                          "format": "uuid"
                        },
                        "currency": {
                          "type": "string",
                          "description": "ISO 4217 currency code",
                          "example": "USD"
                        },
                        "period": {
                          "type": "object",
                          "properties": {
                            "start_date": {
                              "type": "string",
                              "format": "date"
                            },
                            "end_date": {
                              "type": "string",
                              "format": "date"
                            },
                            "window": {
                              "type": "string"
                            }
                          }
                        },
                        "snapshots": {
                          "type": "array",
                          "items": {
                            "$ref": "#/components/schemas/KPISnapshot"
                          }
                        },
                        "metadata": {
                          "type": "object",
                          "properties": {
                            "last_calculated_at": {
                              "type": "string",
                              "format": "date-time"
                            },
                            "data_completeness": {
                              "type": "object",
                              "description": "Flags indicating which data types are available",
                              "properties": {
                                "has_subscriptions": {
                                  "type": "boolean"
                                },
                                "has_invoices": {
                                  "type": "boolean"
                                },
                                "has_cogs": {
                                  "type": "boolean"
                                },
                                "has_sales_marketing": {
                                  "type": "boolean"
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                },
                "examples": {
                  "monthly_summary": {
                    "summary": "12 months of monthly KPI snapshots",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "currency": "USD",
                        "period": {
                          "start_date": "2024-01-01",
                          "end_date": "2024-12-31",
                          "window": "monthly"
                        },
                        "snapshots": [
                          {
                            "period_date": "2024-01-31",
                            "arr": 1200000.0,
                            "mrr": 100000.0,
                            "grr": 95.0,
                            "nrr": 110.0,
                            "cac": 5000.0,
                            "ltv": 50000.0,
                            "gross_margin": 80.0,
                            "arpu": 2000.0,
                            "churn_rate": 2.5,
                            "expansion_rate": 12.5,
                            "contraction_rate": 0.0,
                            "new_customers": 10,
                            "churned_customers": 1,
                            "total_customers": 50,
                            "calculated_at": "2024-10-30T20:00:00Z"
                          },
                          {
                            "period_date": "2024-02-29",
                            "arr": 1260000.0,
                            "mrr": 105000.0,
                            "grr": 96.0,
                            "nrr": 112.0,
                            "cac": 4800.0,
                            "ltv": 52000.0,
                            "gross_margin": 81.0,
                            "arpu": 2100.0,
                            "churn_rate": 2.0,
                            "expansion_rate": 14.0,
                            "contraction_rate": 0.0,
                            "new_customers": 8,
                            "churned_customers": 1,
                            "total_customers": 57,
                            "calculated_at": "2024-10-30T20:00:00Z"
                          }
                        ],
                        "metadata": {
                          "last_calculated_at": "2024-10-30T20:00:00Z",
                          "data_completeness": {
                            "has_subscriptions": true,
                            "has_invoices": true,
                            "has_cogs": true,
                            "has_sales_marketing": true
                          }
                        }
                      }
                    }
                  },
                  "insufficient_data": {
                    "summary": "Company with partial data",
                    "value": {
                      "success": true,
                      "data": {
                        "company_id": "550e8400-e29b-41d4-a716-446655440000",
                        "currency": "USD",
                        "period": {
                          "start_date": "2024-01-01",
                          "end_date": "2024-12-31",
                          "window": "monthly"
                        },
                        "snapshots": [
                          {
                            "period_date": "2024-01-31",
                            "arr": 500000.0,
                            "mrr": 41667.0,
                            "grr": null,
                            "nrr": null,
                            "cac": null,
                            "ltv": null,
                            "gross_margin": null,
                            "arpu": 1389.0,
                            "churn_rate": null,
                            "expansion_rate": null,
                            "contraction_rate": null,
                            "new_customers": 30,
                            "churned_customers": 0,
                            "total_customers": 30,
                            "calculated_at": "2024-10-30T20:00:00Z"
                          }
                        ],
                        "metadata": {
                          "last_calculated_at": "2024-10-30T20:00:00Z",
                          "data_completeness": {
                            "has_subscriptions": true,
                            "has_invoices": false,
                            "has_cogs": false,
                            "has_sales_marketing": false
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Invalid parameters",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "examples": {
                  "invalid_date_range": {
                    "summary": "Invalid date range",
                    "value": {
                      "error": {
                        "code": "INVALID_PARAMETER",
                        "message": "end_date must be after start_date"
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "403": {
            "description": "Forbidden - company not in user's organization",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Company not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "500": {
            "description": "Internal server error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT"
      }
    },
    "schemas": {
      "KPISnapshot": {
        "type": "object",
        "required": ["period_date", "arr", "mrr"],
        "properties": {
          "period_date": {
            "type": "string",
            "format": "date",
            "description": "Last day of month"
          },
          "arr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Annual Recurring Revenue"
          },
          "mrr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "description": "Monthly Recurring Revenue"
          },
          "grr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "nullable": true,
            "description": "Gross Revenue Retention (%)"
          },
          "nrr": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 200,
            "nullable": true,
            "description": "Net Revenue Retention (%)"
          },
          "cac": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "nullable": true,
            "description": "Customer Acquisition Cost"
          },
          "ltv": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "nullable": true,
            "description": "Customer Lifetime Value"
          },
          "gross_margin": {
            "type": "number",
            "format": "decimal",
            "minimum": -100,
            "maximum": 100,
            "nullable": true,
            "description": "Gross Margin (%)"
          },
          "arpu": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "nullable": true,
            "description": "Average Revenue Per User"
          },
          "churn_rate": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "nullable": true,
            "description": "Logo Churn Rate (%)"
          },
          "expansion_rate": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "nullable": true,
            "description": "Expansion MRR Rate (%)"
          },
          "contraction_rate": {
            "type": "number",
            "format": "decimal",
            "minimum": 0,
            "maximum": 100,
            "nullable": true,
            "description": "Contraction MRR Rate (%)"
          },
          "new_customers": {
            "type": "integer",
            "minimum": 0,
            "nullable": true,
            "description": "New customers acquired"
          },
          "churned_customers": {
            "type": "integer",
            "minimum": 0,
            "nullable": true,
            "description": "Customers churned"
          },
          "total_customers": {
            "type": "integer",
            "minimum": 0,
            "nullable": true,
            "description": "Active customers at period end"
          },
          "calculated_at": {
            "type": "string",
            "format": "date-time",
            "description": "When metrics were calculated"
          }
        }
      },
      "Error": {
        "type": "object",
        "required": ["error"],
        "properties": {
          "error": {
            "type": "object",
            "required": ["code", "message"],
            "properties": {
              "code": {
                "type": "string"
              },
              "message": {
                "type": "string"
              },
              "details": {
                "type": "object"
              }
            }
          }
        }
      }
    }
  }
}
